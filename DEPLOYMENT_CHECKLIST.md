# Complete Deployment Checklist & Requirements

## üéØ Current Status

### ‚úÖ Successfully Deployed Resources
- **Deployment**: `ogscout-app`
- **Service**: `ogscout-service`
- **HPA**: `ogscout-app-hpa` (Horizontal Pod Autoscaler)

### ‚ùå Missing/Pending Resources
- **Ingress**: `ogscout-ingress` (configured but may need ingress controller)
- **ConfigMap**: `ogscout-config` (generated by kustomize)
- **Secrets**: `ogscout-secrets` (created by workflow)

---

## üîß Critical Fixes Applied

### 1. Health Check Endpoints ‚úÖ FIXED
**Created:**
- `/api/health` - Basic health check for Kubernetes probes
- `/api/health/deep` - Deep health check with database connectivity

**Why Important:**
- Kubernetes liveness probes check if pod is alive
- Readiness probes check if pod can serve traffic
- Without this, pods may be killed as unhealthy

**Test:**
```bash
curl http://localhost:3000/api/health
curl http://localhost:3000/api/health/deep
```

### 2. Ingress Configuration ‚úÖ FIXED
**Created:**
- `k8s/overlays/prod/ingress-patch.yaml` - Production Ingress customization
- Added patch to production kustomization

**Why Important:**
- Ingress routes external traffic to your application
- Without it, application is only accessible inside cluster

---

## üìã Prerequisites for Full Deployment

### 1. Ingress Controller (REQUIRED)

Your cluster MUST have an ingress controller installed:

#### Check if Ingress Controller Exists:
```bash
kubectl get pods -n ingress-nginx
# OR
kubectl get pods -A | grep ingress
```

#### Install NGINX Ingress Controller:
```bash
# Using Helm
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --set controller.service.type=LoadBalancer

# OR using kubectl
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```

#### Get External IP:
```bash
kubectl get svc -n ingress-nginx
# Look for EXTERNAL-IP in the output
```

### 2. Cert-Manager for TLS (RECOMMENDED)

For HTTPS/TLS certificates:

#### Check if Cert-Manager Exists:
```bash
kubectl get pods -n cert-manager
```

#### Install Cert-Manager:
```bash
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.yaml
```

#### Create ClusterIssuer for Let's Encrypt:
```bash
cat <<EOF | kubectl apply -f -
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com  # CHANGE THIS
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
EOF
```

### 3. DNS Configuration (REQUIRED)

Point your domain to the Ingress LoadBalancer IP:

```bash
# Get the external IP
kubectl get svc -n ingress-nginx ingress-nginx-controller

# Add DNS A records:
# ogscout.com     ‚Üí  <EXTERNAL-IP>
# www.ogscout.com ‚Üí  <EXTERNAL-IP>
```

**DNS Provider Examples:**
- Cloudflare: DNS ‚Üí Add Record ‚Üí Type: A
- Route53: Create A record pointing to LoadBalancer
- DigitalOcean: Networking ‚Üí Domains ‚Üí Add A Record

### 4. MongoDB Configuration (REQUIRED)

Update GitHub Secrets with actual MongoDB connection:

```bash
# For Production
MONGODB_URI_PROD=mongodb+srv://username:password@cluster.mongodb.net/repair-connect?retryWrites=true&w=majority

# For Development
MONGODB_URI_DEV=mongodb+srv://username:password@dev-cluster.mongodb.net/repair-connect?retryWrites=true&w=majority
```

**MongoDB Atlas Setup:**
1. Go to mongodb.com/cloud/atlas
2. Create cluster (Free tier available)
3. Create database user
4. Whitelist IP: `0.0.0.0/0` (allows from anywhere) or your K8s cluster IPs
5. Get connection string
6. Add to GitHub Secrets

---

## üöÄ Deployment Steps

### Step 1: Verify Prerequisites
```bash
# Check ingress controller
kubectl get pods -n ingress-nginx

# Check cert-manager (optional but recommended)
kubectl get pods -n cert-manager

# Check if namespaces exist
kubectl get namespace ogscout-prod
kubectl get namespace ogscout-dev
```

### Step 2: Commit and Push Changes
```bash
git add repair-connect/src/app/api/health/
git add k8s/overlays/prod/ingress-patch.yaml
git add k8s/overlays/prod/kustomization.yaml

git commit -m "fix: add health endpoints and complete K8s configuration

Health Endpoints:
- Create /api/health for basic health checks
- Create /api/health/deep for database connectivity checks
- Required for Kubernetes liveness/readiness probes

Kubernetes Configuration:
- Add ingress-patch.yaml for production Ingress customization
- Update kustomization to include ingress patch
- Ensures proper domain routing and TLS configuration

This completes the required resources for production deployment"

git push origin main
```

### Step 3: Monitor Deployment
```bash
# Watch deployment progress
kubectl get pods -n ogscout-prod -w

# Check deployment status
kubectl rollout status deployment/ogscout-app -n ogscout-prod

# Check all resources
kubectl get all,ingress,configmap,secret -n ogscout-prod
```

### Step 4: Verify Health
```bash
# Check pod logs
kubectl logs -n ogscout-prod -l app=ogscout --tail=50

# Check health endpoint (after ingress is ready)
curl https://ogscout.com/api/health

# Deep health check
curl https://ogscout.com/api/health/deep
```

---

## üîç Troubleshooting Guide

### Issue 1: Pods Not Ready

**Symptoms:**
```
NAME                          READY   STATUS    RESTARTS
ogscout-app-xxx-yyy           0/1     Running   0
```

**Check:**
```bash
kubectl describe pod <pod-name> -n ogscout-prod
kubectl logs <pod-name> -n ogscout-prod
```

**Common Causes:**
- Health check failing (no /api/health endpoint) ‚úÖ FIXED
- MongoDB connection failing
- Missing environment variables
- Image pull errors

**Solutions:**
```bash
# Check if ConfigMap exists
kubectl get configmap -n ogscout-prod

# Check if Secrets exist
kubectl get secret ogscout-secrets -n ogscout-prod

# Verify environment variables in pod
kubectl exec <pod-name> -n ogscout-prod -- env | grep NODE_ENV
```

### Issue 2: Ingress Not Working

**Symptoms:**
- Can't access application via domain
- 404 or connection refused

**Check:**
```bash
# Check if Ingress exists
kubectl get ingress -n ogscout-prod

# Describe Ingress
kubectl describe ingress ogscout-ingress -n ogscout-prod

# Check ingress controller logs
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
```

**Common Causes:**
- Ingress controller not installed ‚ö†Ô∏è CHECK THIS
- DNS not pointing to LoadBalancer IP
- Cert-manager not creating certificates
- Service not routing to pods

**Solutions:**
```bash
# Install ingress controller (see Prerequisites above)

# Check service endpoints
kubectl get endpoints ogscout-service -n ogscout-prod

# Should show pod IPs - if empty, pods aren't ready

# Test service internally
kubectl run -it --rm debug --image=curlimages/curl --restart=Never -- \
  curl http://ogscout-service.ogscout-prod.svc.cluster.local:3000/api/health
```

### Issue 3: TLS Certificate Issues

**Symptoms:**
- HTTPS not working
- Certificate warnings

**Check:**
```bash
# Check certificates
kubectl get certificate -n ogscout-prod

# Check cert-manager logs
kubectl logs -n cert-manager -l app=cert-manager

# Describe certificate
kubectl describe certificate ogscout-tls-prod -n ogscout-prod
```

**Solutions:**
```bash
# Create ClusterIssuer (see Prerequisites)

# Delete and recreate certificate
kubectl delete certificate ogscout-tls-prod -n ogscout-prod
kubectl delete secret ogscout-tls-prod -n ogscout-prod

# Cert-manager will recreate it automatically
```

### Issue 4: Database Connection Failed

**Symptoms:**
- Deep health check fails
- Application logs show MongoDB errors

**Check:**
```bash
# Test MongoDB connection from pod
kubectl exec <pod-name> -n ogscout-prod -- env | grep MONGODB

# Check if MongoDB URI is correct
```

**Solutions:**
- Verify MongoDB Atlas IP whitelist includes `0.0.0.0/0`
- Check MongoDB username/password are correct
- Ensure database exists in cluster
- Verify connection string format

### Issue 5: Image Pull Errors

**Symptoms:**
```
ErrImagePull
ImagePullBackOff
```

**Check:**
```bash
kubectl describe pod <pod-name> -n ogscout-prod
# Look for image pull errors
```

**Solutions:**
```bash
# Verify image exists
docker pull ghcr.io/service-go-repo/ogscout:prod-<sha>

# Check if pull secret exists
kubectl get secret ghcr-secret -n ogscout-prod

# Recreate pull secret (done by workflow)
```

---

## ‚úÖ Verification Checklist

Run these commands after deployment:

```bash
# 1. Check all resources are created
kubectl get all,ingress,configmap,secret -n ogscout-prod

# Expected output:
# deployment.apps/ogscout-app
# service/ogscout-service
# horizontalpodautoscaler.autoscaling/ogscout-app-hpa
# ingress.networking.k8s.io/ogscout-ingress
# configmap/ogscout-config-<hash>
# secret/ogscout-secrets
# secret/ghcr-secret

# 2. Check pods are running and ready
kubectl get pods -n ogscout-prod
# All pods should be 1/1 Ready

# 3. Check service endpoints
kubectl get endpoints ogscout-service -n ogscout-prod
# Should show pod IPs

# 4. Check ingress has address
kubectl get ingress ogscout-ingress -n ogscout-prod
# Should show LoadBalancer IP in ADDRESS column

# 5. Test health endpoint internally
kubectl run -it --rm test --image=curlimages/curl --restart=Never -- \
  curl http://ogscout-service.ogscout-prod.svc.cluster.local:3000/api/health

# 6. Test from external (after DNS is configured)
curl https://ogscout.com/api/health
curl https://ogscout.com/api/health/deep

# 7. Check TLS certificate
curl -I https://ogscout.com
# Should return 200 OK with valid certificate
```

---

## üìä Monitoring Commands

```bash
# Watch pod status
kubectl get pods -n ogscout-prod -w

# Stream logs
kubectl logs -n ogscout-prod -l app=ogscout -f

# Check resource usage
kubectl top pods -n ogscout-prod

# Check HPA status
kubectl get hpa -n ogscout-prod

# Check events
kubectl get events -n ogscout-prod --sort-by='.lastTimestamp'

# Full status
kubectl describe deployment ogscout-app -n ogscout-prod
```

---

## üéØ Next Steps After Successful Deployment

1. **Set up monitoring:**
   - Consider Prometheus + Grafana
   - Set up alerts for pod failures
   - Monitor resource usage

2. **Configure backups:**
   - MongoDB automated backups
   - Kubernetes resource backups (Velero)

3. **Set up CI/CD for development:**
   - Deploy to dev namespace from develop branch
   - Test there before promoting to prod

4. **Security hardening:**
   - Rotate secrets regularly
   - Enable network policies
   - Use RBAC properly
   - Regular security scans

5. **Performance optimization:**
   - Adjust HPA thresholds based on traffic
   - Optimize resource limits
   - Enable caching where appropriate

---

## üìû Support

If you encounter issues:

1. Check this troubleshooting guide
2. Review GitHub Actions logs
3. Check Kubernetes events: `kubectl get events -n ogscout-prod`
4. Examine pod logs: `kubectl logs <pod-name> -n ogscout-prod`

**Most Common Issue:** Ingress controller not installed!

---

**Last Updated:** 2025-01-24
**Version:** 1.0.0
